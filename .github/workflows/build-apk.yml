name: Build APK

on:
  workflow_dispatch:
    inputs:
      config_id:
        required: true
        type: string
      version:
        required: true
        type: string
      app_name:
        required: true
        type: string
      server_url:
        required: true
        type: string
      icon_url:
        required: false
        type: string
      tracking_id:
        required: false
        type: string
      permissions:
        required: false
        type: string
      callback_url:
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Capacitor & Build
        working-directory: /tmp
        run: |
          mkdir -p apk-build
          cd apk-build
          npm init -y
          npm install @capacitor/core @capacitor/cli @capacitor/android
          npx cap init "${{ inputs.app_name }}" "com.clearhuma.app" --web-dir=www
          mkdir -p www
          cat > www/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
            <title>ClearHuma</title>
            <style>body{margin:0;display:flex;align-items:center;justify-content:center;height:100vh;background:#0a0a0a;color:#fff;font-family:system-ui}</style>
          </head>
          <body><p>YÃ¼kleniyor...</p></body>
          </html>
          HTMLEOF
          
          # Configure Capacitor to use server URL (loads remote app with activation screen)
          cat > capacitor.config.json << CAPEOF
          {
            "appId": "com.clearhuma.app",
            "appName": "${{ inputs.app_name }}",
            "webDir": "www",
            "server": {
              "url": "${{ inputs.server_url }}/activate?forceHideBadge=true",
              "cleartext": true,
              "androidScheme": "https",
              "allowNavigation": ["*"]
            },
            "android": {
              "allowMixedContent": true,
              "captureInput": true,
              "webContentsDebuggingEnabled": false
            }
          }
          CAPEOF
          
          npx cap add android

      - name: Configure Android App
        run: |
          cd /tmp/apk-build
          sed -i "s|<string name=\"app_name\">.*</string>|<string name=\"app_name\">${{ inputs.app_name }}</string>|g" android/app/src/main/res/values/strings.xml
          sed -i "s|versionName \"1.0\"|versionName \"${{ inputs.version }}\"|g" android/app/build.gradle
          
          # Add Android permissions
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          sed -i '/<\/manifest>/i \
            <uses-permission android:name="android.permission.INTERNET" \/>\
            <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" \/>\
            <uses-permission android:name="android.permission.CAMERA" \/>\
            <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" \/>\
            <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" \/>\
            <uses-permission android:name="android.permission.POST_NOTIFICATIONS" \/>\
            <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" \/>\
            <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" \/>\
            <uses-permission android:name="android.permission.RECORD_AUDIO" \/>\
            <uses-permission android:name="android.permission.READ_MEDIA_IMAGES" \/>\
            <uses-permission android:name="android.permission.READ_MEDIA_VIDEO" \/>' "$MANIFEST"
          
          # Force WebView to handle ALL URLs internally - never open external browser
          ACTIVITY_FILE=$(find android/app/src/main -name "MainActivity.java" -o -name "MainActivity.kt" | head -1)
          if [[ "$ACTIVITY_FILE" == *".java" ]]; then
            cat > "$ACTIVITY_FILE" << 'JAVAEOF'
          package com.clearhuma.app;

          import com.getcapacitor.BridgeActivity;
          import android.os.Bundle;
          import android.view.View;

          public class MainActivity extends BridgeActivity {
              @Override
              protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  getWindow().getDecorView().setSystemUiVisibility(
                      View.SYSTEM_UI_FLAG_LAYOUT_STABLE | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN
                  );
              }
          }
          JAVAEOF
          fi
          
          # Set fullscreen theme in styles.xml
          STYLES="android/app/src/main/res/values/styles.xml"
          if [ -f "$STYLES" ]; then
            sed -i 's|<style name="AppTheme.NoActionBar" parent="Theme.AppCompat.NoActionBar">|<style name="AppTheme.NoActionBar" parent="Theme.AppCompat.NoActionBar">\n        <item name="android:windowFullscreen">false</item>\n        <item name="android:statusBarColor">@android:color/black</item>\n        <item name="android:navigationBarColor">@android:color/black</item>|' "$STYLES"
          fi

      - name: Download custom icon
        if: ${{ inputs.icon_url != '' }}
        run: |
          cd /tmp/apk-build
          curl -L -o icon.png "${{ inputs.icon_url }}"
          for dir in mdpi hdpi xhdpi xxhdpi xxxhdpi; do
            mkdir -p "android/app/src/main/res/mipmap-${dir}"
            cp icon.png "android/app/src/main/res/mipmap-${dir}/ic_launcher.png"
            cp icon.png "android/app/src/main/res/mipmap-${dir}/ic_launcher_round.png"
          done

      - name: Fix Kotlin stdlib conflicts
        run: |
          cd /tmp/apk-build/android
          cat >> app/build.gradle << 'EOF'

          configurations.all {
              resolutionStrategy {
                  force 'org.jetbrains.kotlin:kotlin-stdlib:1.9.24'
                  force 'org.jetbrains.kotlin:kotlin-stdlib-jdk7:1.9.24'
                  force 'org.jetbrains.kotlin:kotlin-stdlib-jdk8:1.9.24'
              }
          }
          EOF

      - name: Build Debug APK
        run: |
          cd /tmp/apk-build/android
          chmod +x gradlew
          ./gradlew assembleDebug

      - name: Upload APK via Edge Function
        run: |
          APK_PATH=$(find /tmp/apk-build/android/app/build/outputs/apk/debug -name "*.apk" | head -1)
          APK_NAME="${{ inputs.app_name }}-${{ inputs.version }}.apk"
          UPLOAD_URL="${{ inputs.callback_url }}"
          
          # Replace callback function path with upload function path
          BASE_URL=$(echo "$UPLOAD_URL" | sed 's|/functions/v1/.*|/functions/v1/upload-apk|')
          
          curl -X POST "${BASE_URL}?filename=${APK_NAME}&config_id=${{ inputs.config_id }}&secret=${{ secrets.CALLBACK_SECRET }}" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @"${APK_PATH}"

      - name: Notify failure
        if: failure()
        run: |
          curl -X POST "${{ inputs.callback_url }}" \
            -H "Content-Type: application/json" \
            -d "{\"config_id\":\"${{ inputs.config_id }}\",\"status\":\"failed\",\"build_log\":\"Build failed - check GitHub Actions logs at https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\",\"secret\":\"${{ secrets.CALLBACK_SECRET }}\"}"
